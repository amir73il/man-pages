#!/bin/bash
#
# Copyright 2024, Alejandro Colomar <alx@kernel.org>
# SPDX-License-Identifier: GPL-3.0-or-later

set -Eeuo pipefail;
shopt -s lastpipe;


# Defaults:
s='';
u='-u';
w='';


err()
{
	>&2 echo "$(basename "$0"): error: $*";
	exit 1;
}


while getopts "sU:w" opt; do
	case "$opt" in
	s)	s='-s';		;;
	U)	u="-U$OPTARG";	;;
	w)	w='-w';		;;
	\?)	exit 1;		;;
	*)	exit 1;		;;
	esac;
done;
shift $((OPTIND-1));


if test $# -ne 2; then
	err "Expected two arguments.";
fi;

printf '%s\n' "$1.XXXXXX" \
| sed 's,.*/,,' \
| xargs mktemp -t \
| read -r t1;

printf '%s\n' "$2.XXXXXX" \
| sed 's,.*/,,' \
| xargs mktemp -t \
| read -r t2;

test -v MAN_KEEP_FORMATTING \
|| export MAN_KEEP_FORMATTING=1;

man "$1" >"$t1";
man "$2" >"$t2";


# shellcheck disable=SC2206  # We want only non-empty variables in the array.
opts=($s $w $u);


diff --label "$1" --label "$2" "${opts[@]}" "$t1" "$t2";
